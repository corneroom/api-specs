#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

/**
 * Generate Postman collections from gateway specs and preserve existing test scripts
 */

// Read gateway config to get available gateways
function getGatewaySpecs() {
  const configPath = path.resolve(__dirname, '..', 'gateway', 'config.json');
  if (!fs.existsSync(configPath)) {
    console.error('Gateway config.json not found');
    return [];
  }
  
  const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
  const specs = [];
  
  for (const gatewayName of Object.keys(config.gateways)) {
    // Try Swagger spec first (generated by workflow), fallback to YAML
    const swaggerSpec = path.resolve(__dirname, '..', 'gateway', `${gatewayName}-swagger.yaml`);
    const yamlSpec = path.resolve(__dirname, '..', 'gateway', `${gatewayName}.yaml`);
    
    let specPath;
    if (fs.existsSync(swaggerSpec)) {
      specPath = swaggerSpec;
      console.log(`Using Swagger spec: ${gatewayName}-swagger.yaml`);
    } else if (fs.existsSync(yamlSpec)) {
      specPath = yamlSpec;
      console.log(`Using YAML spec: ${gatewayName}.yaml`);
    } else {
      console.warn(`No spec found for gateway: ${gatewayName}`);
      continue;
    }
    
    specs.push({
      name: `${gatewayName}-gateway`,
      spec: path.relative(path.resolve(__dirname, '..'), specPath),
      collectionName: `Project X - ${config.gateways[gatewayName].name || gatewayName}`
    });
  }
  
  return specs;
}

function generateCollectionFromSpec(specPath, outputPath) {
  console.log(`Generating Postman collection from ${specPath}...`);
  
  const args = [
    '-s', specPath,
    '-o', outputPath,
    '-p',
    '-O', 'folderStrategy=Tags,includeAuthInfoInExample=false'
  ];
  
  try {
    execSync(`npx openapi-to-postmanv2 ${args.join(' ')}`, { 
      stdio: 'inherit',
      cwd: path.resolve(__dirname, '..')
    });
    console.log(`‚úÖ Generated collection: ${outputPath}`);
  } catch (error) {
    console.error(`‚ùå Failed to generate collection from ${specPath}:`, error.message);
    throw error;
  }
}

function main() {
  console.log('üöÄ Starting Postman collection generation from gateway specs...');
  
  const outputDir = path.resolve(__dirname, '..', 'postman-collections');
  
  // Ensure output directory exists
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }
  
  const gatewaySpecs = getGatewaySpecs();
  
  if (gatewaySpecs.length === 0) {
    console.error('‚ùå No gateway specs found');
    process.exit(1);
  }
  
  for (const gateway of gatewaySpecs) {
    const specPath = path.resolve(__dirname, '..', gateway.spec);
    const outputPath = path.join(outputDir, `${gateway.name}.postman_collection.json`);
    
    if (!fs.existsSync(specPath)) {
      console.warn(`‚ö†Ô∏è  Gateway spec not found: ${specPath}`);
      continue;
    }
    
    generateCollectionFromSpec(specPath, outputPath);
  }
  
  console.log('‚úÖ All Postman collections generated successfully!');
  console.log(`üìÅ Collections saved to: ${outputDir}`);
}

if (require.main === module) {
  main();
}

module.exports = { generateCollectionFromSpec, GATEWAY_SPECS };
